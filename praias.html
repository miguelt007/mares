<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Praias com Previsão Marítima</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .popup-content { font-size: 14px; }
    .forecast { margin-top: 10px; font-size: 13px; background: #eef; padding: 8px; border-radius: 6px; }
    button { margin-top: 5px; padding: 6px 12px; font-size: 13px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const apiKey = 'bc935843-d537-441f-8524-c2cf2150f46d'; // 🔑 Substitui pela tua chave da Stormglass

    const map = L.map('map').setView([38.7, -9.3], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const praias = [
      { nome: "Praia de São João", lat: 38.6336, lon: -9.2333 },
      { nome: "Praia da Cruz Quebrada", lat: 38.7075, lon: -9.2425 },
      { nome: "Praia de Carcavelos", lat: 38.6761, lon: -9.3311 },
      { nome: "Praia de Paço de Arcos", lat: 38.6953, lon: -9.2964 },
      { nome: "Praia de São Julião", lat: 38.9386, lon: -9.4175 },
      { nome: "Praia da Saúde", lat: 38.6333, lon: -9.2333 },
      { nome: "Nova Praia", lat: 38.6333, lon: -9.2333 },
      { nome: "Praia da Fonte da Telha", lat: 38.5650, lon: -9.1933 }
    ];

    praias.forEach(praia => {
      const marker = L.marker([praia.lat, praia.lon]).addTo(map);
      const popupContent = `
        <div class="popup-content" id="popup-${praia.nome.replace(/\s+/g, '')}">
          <strong>${praia.nome}</strong><br>
          <button onclick="verPrevisao(${praia.lat}, ${praia.lon}, '${praia.nome}')">Ver Previsão</button>
          <div class="forecast" id="forecast-${praia.nome.replace(/\s+/g, '')}"></div>
        </div>
      `;
      marker.bindPopup(popupContent);
    });

    async function verPrevisao(lat, lon, nome) {
      const forecastDiv = document.getElementById(`forecast-${nome.replace(/\s+/g, '')}`);
      forecastDiv.innerHTML = "🔄 A carregar...";

      try {
        const response = await fetch(`https://api.stormglass.io/v2/weather/point?lat=${lat}&lng=${lon}&params=waveHeight,windSpeed,airTemperature,waterTemperature`, {
          headers: {
            'Authorization': apiKey
          }
        });

        if (!response.ok) {
          forecastDiv.innerHTML = `❌ Erro ${response.status}: ${response.statusText}`;
          return;
        }

        const data = await response.json();
        const hora = data.hours?.[0];

        if (!hora) {
          forecastDiv.innerHTML = "⚠️ Sem dados disponíveis para esta hora.";
          return;
        }

        forecastDiv.innerHTML = `
          <strong>🌤️ Previsão:</strong><br>
          🌊 Ondas: ${hora.waveHeight?.noaa ?? 'N/D'} m<br>
          💨 Vento: ${hora.windSpeed?.noaa ?? 'N/D'} m/s<br>
          🌡️ Ar: ${hora.airTemperature?.noaa ?? 'N/D'} °C<br>
          🌊 Água: ${hora.waterTemperature?.noaa ?? 'N/D'} °C
        `;
      } catch (error) {
        forecastDiv.innerHTML = "❌ Erro ao obter previsão.";
        console.error("Erro na chamada à Stormglass API:", error);
      }
    }
  </script>
</body>
</html>
